/*! Bkeditor - v0.9.0 - 2013-08-03
* https://github.com/daixianfeng/bkeditor
* Copyright (c) 2013 daixianfeng;*/
(function(){function e(e,t){var n=r.nodeIndex;e=e.duplicate(),e.collapse(t);var i=e.parentElement();if(!i.hasChildNodes())return{container:i,offset:0};for(var a,o,s=i.children,l=e.duplicate(),d=0,c=s.length-1,u=-1;c>=d;){u=Math.floor((d+c)/2),a=s[u],l.moveToElementText(a);var f=l.compareEndPoints("StartToStart",e);if(f>0)c=u-1;else{if(!(0>f))return{container:i,offset:n(a)};d=u+1}}if(-1==u){if(l.moveToElementText(i),l.setEndPoint("StartToStart",e),o=l.text.replace(/(\r\n|\r)/g,"\n").length,s=i.childNodes,!o)return a=s[s.length-1],{container:a,offset:a.nodeValue.length};for(var m=s.length;o>0;)o-=s[--m].nodeValue.length;return{container:s[m],offset:-o}}if(l.collapse(f>0),l.setEndPoint(f>0?"StartToStart":"EndToStart",e),o=l.text.replace(/(\r\n|\r)/g,"\n").length,!o){if(p===void 0)var p=window.parent.DTD;return p.$empty[a.tagName]||p.$nonChild[a.tagName]?{container:i,offset:n(a)+(f>0?0:1)}:{container:a,offset:f>0?0:a.childNodes.length}}for(;o>0;)try{var h=a;a=a[f>0?"previousSibling":"nextSibling"],o-=a.nodeValue.length}catch(g){return{container:i,offset:n(h)}}return{container:a,offset:f>0?-o:a.nodeValue.length+o}}function t(t,n){if(t.item)n.selectNode(t.item(0));else{var r=e(t,!0);n.setStart(r.container,r.offset),0!=t.compareEndPoints("StartToEnd",t)?(r=e(t,!1),n.setEnd(r.container,r.offset)):n.collapse(!0)}return n}function n(e){this._document=e;var t=this;e.attachEvent("onselectionchange",function(){t._selectionChangeHandler()})}var r={isBody:function(e){return e&&1==e.nodeType&&"body"==e.tagName.toLowerCase()},nodeIndex:function(e){for(var t=0;e=e.previousSibling;t++)continue;return t},findParent:function(e){return r.isBody(e)?null:e.parentNode},findParents:function(e,t){for(var n=[];null!==e&&e!==t;)n.push(e),e=r.findParent(e);return n},getCommonAncestor:function(e){var t=e.startContainer,n=e.endContainer;if(e.startOffset,e.endOffset,t===n)return 1==t.nodeType?t:3==t.nodeType?t.parentNode:t;for(var r=[t],i=[n],a=t,o=-1;a=a.parentNode;){if(a===n)return a;r.push(a)}for(a=n;a=a.parentNode;){if(a===t)return a;i.push(a)}for(r.reverse(),i.reverse();o++,r[o]===i[o];);return 0==o?null:r[o-1]},isDataNode:function(e){return e&&null!==e.nodeValue&&null!==e.data},isAncestorOf:function(e,t){return!r.isDataNode(e)&&(e.contains(r.isDataNode(t)?t.parentNode:t)||t.parentNode==e)},isAncestorOrSelf:function(e,t){return r.isAncestorOf(e,t)||e==t},getNodeLength:function(e){return r.isDataNode(e)?e.length:e.childNodes.length},splitDataNode:function(e,t){if(!r.isDataNode(e))return!1;var n=e.cloneNode(!1);e.deleteData(t,e.length),n.deleteData(0,t),e.parentNode.insertBefore(n,e.nextSibling)},pushNode:function(e,t,n){for(var i=e.firstChild;i;)(i.nodeType===n||n===void 0)&&t.push(i),r.pushNode(i,t,n),i=i.nextSibling}},i={convertToDOMRange:function(e,t){function n(e,n,r){var i=t.createElement("a"),a=n.duplicate();a.collapse(r);var o=a.parentElement();do o.insertBefore(i,i.previousSibling),a.moveToElementText(i);while(a.compareEndPoints(r?"StartToStart":"StartToEnd",n)>0&&i.previousSibling);-1==a.compareEndPoints(r?"StartToStart":"StartToEnd",n)&&i.nextSibling?(a.setEndPoint(r?"EndToStart":"EndToEnd",n),e[r?"setStart":"setEnd"](i.nextSibling,a.text.length)):e[r?"setStartBefore":"setEndBefore"](i),i.parentNode.removeChild(i)}var r=new DOMRange(t);return n(r,e,!0),n(r,e,!1),r},convertFromDOMRange:function(e){function t(e,t,n){var i=t[n?"startContainer":"endContainer"],a=t[n?"startOffset":"endOffset"],o=0,s=r.isDataNode(i)?i:i.childNodes[a],l=r.isDataNode(i)?i.parentNode:i;(3==i.nodeType||4==i.nodeType)&&(o=a);var d=t._document.createElement("a");s?l.insertBefore(d,s):l.appendChild(d);var c=t._document.body.createTextRange();c.moveToElementText(d),d.parentNode.removeChild(d),e.setEndPoint(n?"StartToStart":"EndToStart",c),e[n?"moveStart":"moveEnd"]("character",o)}var n=e._document.body.createTextRange();return t(n,e,!1),t(n,e,!0),n}};document.createNodeIterator=function(e,t){var n=[],i=e.firstChild;for(e.nextNode=function(){return n.shift()};i;)(i.nodeType===t||t===void 0)&&n.push(i),r.pushNode(i,n,t),i=i.nextSibling;return e},document.createRange=function(){var e=new DOMRange(document),t=e._index;return DOMRange._rangeQuery[t]=e,e},DOMRange=function(e){this._document=e,this._index=DOMRange._rangeQuery.length,this.startContainer=e,this.endContainer=e,this.startOffset=0,this.endOffset=0,this.commonAncestorContainer=e,this.collapsed=!0,this._startBefore=e,this._startAfter=e,this._endBefore=e,this._endAfter=e},DOMRange._rangeQuery=[],DOMRange.START_TO_START=0,DOMRange.START_TO_END=1,DOMRange.END_TO_END=2,DOMRange.END_TO_START=3,DOMRange._refreshRange=function(e){for(var t=DOMRange._rangeQuery,n=t.length,r=0;n>r;r++)if(e!==r){var i=t[r],a=i._document,o=!1,s=!1;i&&i.startContainer!==a&&i.endContainer!==a&&(i.startContainer&&3!==i.startContainer.nodeType?(i.startContainer.childNodes[i.startOffset-1]?i.startContainer.childNodes[i.startOffset-1]!==i._startBefore&&(o=!0):"firstChild"!==i._startBefore&&(o=!0),i.startContainer.childNodes[i.startOffset]?i.startContainer.childNodes[i.startOffset]!==i._startAfter&&(o=!0):"lastChild"!==i._startAfter&&(o=!0),"text"===i._startAfter&&(o=!1),o===!0&&("lastChild"===i._startAfter?i.startOffset=i.startContainer.childNodes.length:i._startAfter&&i._startAfter.parentNode===i.startContainer?i.setStartBefore(i._startAfter,1):"firstChild"===i._startBefore?i.startOffset=0:i._startBefore&&i._startBefore.parentNode===i.startContainer?i.setStartAfter(i._startBefore,1):(i.startContainer=a,i.startOffset=0))):i.startContainer||(i.startContainer=a,i.startOffset=0),i.endContainer&&3!==i.endContainer.nodeType?(i.endContainer.childNodes[i.endOffset-1]?i.endContainer.childNodes[i.endOffset-1]!==i._endBefore&&(s=!0):"firstChild"!==i._endBefore&&(s=!0),i.endContainer.childNodes[i.endOffset]?i.endContainer.childNodes[i.endOffset]!==i._endAfter&&(s=!0):"lastChild"!==i._endAfter&&(s=!0),"text"===i._endBefore&&(s=!1),s===!0&&("firstChild"===i._endBefore?i.endOffset=0:i._endBefore&&i._endBefore.parentNode===i.endContainer?i.setEndAfter(i._endBefore,2):"lastChild"===i._endAfter?i.endOffset=i.endContainer.childNodes.length:i._endAfter&&i._endAfter.parentNode===i.endContainer?i.setEndBefore(i._endAfter,2):(i.endContainer=a,i.endOffset=0))):i.endContainer||(i.endContainer=a,i.endOffset=0))}},DOMRange.prototype={START_TO_START:0,START_TO_END:1,END_TO_END:2,END_TO_START:3,_refreshProperties:function(e){e=e===void 0?3:e,this.collapsed=this.startContainer==this.endContainer&&this.startOffset==this.endOffset,this.commonAncestorContainer=r.getCommonAncestor(this),1&e&&(3!==this.startContainer.nodeType?(this._startBefore=this.startContainer.childNodes[this.startOffset-1]?this.startContainer.childNodes[this.startOffset-1]:"firstChild",this._startAfter=this.startContainer.childNodes[this.startOffset]?this.startContainer.childNodes[this.startOffset]:"lastChild"):this._startBefore=this._startAfter="text"),2&e&&(3!==this.endContainer.nodeType?(this._endBefore=this.endContainer.childNodes[this.endOffset-1]?this.endContainer.childNodes[this.endOffset-1]:"firstChild",this._endAfter=this.endContainer.childNodes[this.endOffset]?this.endContainer.childNodes[this.endOffset]:"lastChild"):this._endBefore=this._endAfter="text")},setStart:function(e,t,n){n=n===void 0?3:n,this.startContainer=e,this.startOffset=t,this._refreshProperties(n)},setEnd:function(e,t,n){n=n===void 0?3:n,this.endContainer=e,this.endOffset=t,this._refreshProperties(n)},setStartBefore:function(e,t){t=t===void 0?3:t,this.setStart(e.parentNode,r.nodeIndex(e),t)},setStartAfter:function(e,t){t=t===void 0?3:t,this.setStart(e.parentNode,r.nodeIndex(e)+1,t)},setEndBefore:function(e,t){t=t===void 0?3:t,this.setEnd(e.parentNode,r.nodeIndex(e),t)},setEndAfter:function(e,t){t=t===void 0?3:t,this.setEnd(e.parentNode,r.nodeIndex(e)+1,t)},selectNode:function(e){this.setStartBefore(e),this.setEndAfter(e)},selectNodeContents:function(e){this.setStart(e,0),this.setEnd(e,r.getNodeLength(e))},collapse:function(e){e?this.setEnd(this.startContainer,this.startOffset):this.setStart(this.endContainer,this.endOffset),this._refreshProperties()},deleteContents:function(){var e=!0,t=!1;this._optContents(e,t)},cloneContents:function(){var e=!1,t=!0;return this._optContents(e,t)},extractContents:function(){var e=!0,t=!0;return this._optContents(e,t)},_optContents:function(e,t){var n=this.startContainer,i=this.endContainer,a=this.startOffset,o=this.endOffset,s=this.commonAncestorContainer;if(frag=document.createDocumentFragment(),tmpStart={},tmpEnd={},startType=!1,endType=!1,this.collapsed)return frag;if(3===n.nodeType&&(startType=!0),3===i.nodeType&&(endType=!0),n===i&&startType&&endType){var l=n.nodeValue.slice(a,o),d=document.createTextNode(l);if(e){var c=n.nodeValue.slice(0,a),u=n.nodeValue.slice(o),f=document.createTextNode(c),m=document.createTextNode(u);n.parentNode.replaceChild(m,n),m.parentNode.insertBefore(f,m),this.setStart(m.parentNode,r.nodeIndex(f)+1),this.collapse(!0)}return frag.appendChild(d),t?frag:void 0}if(startType){var l=n.nodeValue.slice(a),d=document.createTextNode(l);e&&(n.nodeValue=n.nodeValue.slice(0,a)),a=r.nodeIndex(n),n=n.parentNode}if(endType){var p=i.nodeValue.slice(0,o),h=document.createTextNode(p);e&&(i.nodeValue=i.nodeValue.slice(o)),o=r.nodeIndex(i)+1,i=i.parentNode}var g=r.findParents(n,s),b=r.findParents(i,s),v=n.childNodes[a],y=i.childNodes[o-1];g.unshift(v),b.unshift(y),tmpStart=g.pop(),tmpEnd=b.pop();var w=tmpStart.nextSibling;tmpStart===tmpEnd&&(w=null);var E=frag,C=r.nodeIndex(tmpStart);for((0!==g.length||startType)&&(C+=1);"object"==typeof tmpStart;){if(tmpStart===v){if(!startType){if(tmpStart!==y&&tmpStart!==tmpEnd)E.firstChild?E.insertBefore(tmpStart,E.firstChild):E.appendChild(tmpStart);else var k=!0;break}E.firstChild?E.insertBefore(d,E.firstChild):E.appendChild(d);var T=g.pop()}else{var T=g.pop(),x="object"==typeof T?r.nodeIndex(T):a,N=tmpStart.childNodes[x]?tmpStart.childNodes[x].nextSibling:void 0,S=tmpStart.cloneNode(!1);for(E.firstChild?E.insertBefore(S,E.firstChild):E.appendChild(S);N;){var j=N.nextSibling;if(e)S.appendChild(N);else{var R=w.cloneNode(!0);S.appendChild(R)}N=j}}E=S,tmpStart=T}for(E=frag;null!==w&&w!==s.lastChild&&w!==tmpEnd;){var j=w.nextSibling;if(e)frag.appendChild(w);else{var R=w.cloneNode(!0);frag.appendChild(R)}w=j}for(w===tmpEnd&&(k=!0),E=frag;"object"==typeof tmpEnd;){if(tmpEnd===y){if(!endType){k&&E.appendChild(tmpEnd);break}E.appendChild(h);var _=b.pop()}else{for(var L=tmpEnd.firstChild,S=tmpEnd.cloneNode(!1),_=b.pop(),I="object"==typeof _?r.nodeIndex(_):o,D=tmpEnd.childNodes[I];L&&L!==D;){var j=L.nextSibling;if(e)S.appendChild(L);else{var R=w.cloneNode(!0);S.appendChild(R)}L=j}E.appendChild(S)}E=S,tmpEnd=_}return e&&(DOMRange._refreshRange(this._index),this.setStart(s,C),this.collapse(!0)),t?frag:void 0},cloneRange:function(){var e=new DOMRange(this._document);e.setStart(this.startContainer,this.startOffset),e.setEnd(this.endContainer,this.endOffset);var t=e._index;return DOMRange._rangeQuery[t]=e,e},insertNode:function(e){if(11!==e.nodeType)return r.isDataNode(this.startContainer)?(r.splitDataNode(this.startContainer,this.startOffset),this.startContainer.parentNode.insertBefore(e,this.startContainer.nextSibling)):this.startContainer.childNodes[this.startOffset]?this.startContainer.insertBefore(e,this.startContainer.childNodes[this.startOffset]):this.startContainer.appendChild(e),DOMRange._refreshRange(this._index),this.setStart(this.startContainer,this.startOffset),this.setEnd(this.startContainer,this.startOffset+1),this.startOffset;var t=e.lastChild,n=e.firstChild;e.lastChild;for(var i=e.childNodes.length;t;){preNode=t.previousSibling;var a=this.insertNode(t);if(t===n)var o=a;t=preNode}if(i){var s=o+i;DOMRange._refreshRange(this._index),this.setStart(this.startContainer,o),this.setEnd(this.startContainer,s)}},surroundContents:function(e){var t=this.extractContents();this.insertNode(e),e.appendChild(t),DOMRange._refreshRange(this._index),this.selectNode(e)},detach:function(){DOMRange._rangeQuery.splice(this._index,1)},createContextualFragment:function(e){var t=(r.isDataNode(this.startContainer)?this.startContainer.parentNode:this.startContainer).cloneNode(!1);t.innerHTML=e;for(var n=this._document.createDocumentFragment();t.firstChild;)n.appendChild(t.firstChild);return n},compareBoundaryPoints:function(e,t){var n,r,i,a;switch(e){case DOMRange.START_TO_START:case DOMRange.END_TO_START:n=this.startContainer,r=this.startOffset,3!==n.nodeType&&(r>=n.childNodes.length&&n.lastChild?(n=n.lastChild,r=2147483647):(n=n.childNodes[r],r=-1));break;case DOMRange.END_TO_END:case DOMRange.START_TO_END:n=this.endContainer,r=this.endOffset,3!==n.nodeType&&(r>=n.childNodes.length&&n.lastChild?(n=n.lastChild,r=2147483647):(n=n.childNodes[r],r=-1))}switch(e){case DOMRange.START_TO_START:case DOMRange.START_TO_END:i=t.startContainer,a=t.startOffset,3!==i.nodeType&&(a>=i.childNodes.length&&i.lastChild?(i=i.lastChild,a=2147483647):(i=i.childNodes[a],a=-1));break;case DOMRange.END_TO_START:case DOMRange.END_TO_END:i=t.endContainer,a=t.endOffset,3!==i.nodeType&&(a>=i.childNodes.length&&i.lastChild?(i=i.lastChild,a=2147483647):(i=i.childNodes[a],a=-1))}if(n===i)return a>r?-1:r==a?0:1;var o=this._document.createElement("a"),s=this._document.createElement("a");n.parentNode.insertBefore(o,n),i.parentNode.insertBefore(s,i);var l;return l=o.nextSibling===s?0:o.sourceIndex<s.sourceIndex?-1:1,n.parentNode.removeChild(o),i.parentNode.removeChild(s),l},toString:function(){return i.convertFromDOMRange(this).text},constructor:DOMRange},n.prototype={rangeCount:0,_document:null,_selectionChangeHandler:function(){this.rangeCount=this._selectionExists(this._document.selection.createRange())?1:0},_selectionExists:function(e){try{return 0!=e.compareEndPoints("StartToEnd",e)||e.parentElement().isContentEditable}catch(t){return!1}},addRange:function(e){var t=this._document.body.createTextRange(),n=i.convertFromDOMRange(e);this._selectionExists(t)?n.select():(t.setEndPoint("StartToStart",n),t.setEndPoint("EndToEnd",n),t.select())},removeAllRanges:function(){this._document.selection.empty()},getRangeAt:function(){var e=this._document.selection.createRange(),n=new DOMRange(this._document);if(this._selectionExists(e)){var r=t(e,n),i=r.startContainer.childNodes[r.startOffset],a=r.endContainer.childNodes[r.endOffset-1];if(i){for(;i.nextSibling;){var o=3===i.nodeType?i.nodeValue:i.innerText;if(0!=o.length)break;i=i.nextSibling}for(;i.firstChild;)i=i.firstChild;r.setStart(i,0)}if(a){for(;a.nextSibling;){var o=3===a.nodeType?a.nodeValue:a.innerText;if(0!=o.length)break;a=a.previousSibling}for(;a.lastChild;)a=a.lastChild;3===a.nodeType?r.setEnd(a,a.nodeValue.length):r.setEnd(a,a.childNodes.length)}return r}return null},toString:function(){return this._document.selection.createRange().text}};var a=new n(document);window.getSelection=function(){return a}})();