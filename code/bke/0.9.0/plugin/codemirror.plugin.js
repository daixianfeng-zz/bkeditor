/*! Bkeditor - v0.9.0 - 2013-08-03
* https://github.com/daixianfeng/bkeditor
* Copyright (c) 2013 daixianfeng;*/
(function(e,t){function n(n){n=n.replace(/\n+/g,"");var r=t("<div></div>").append(n),i=null;r.children().each(function(){try{i=t(this),i.after("\n\n")}catch(e){}});var o=r.find("table");return o.size()&&o.find("tr,td,th").after("\n").before("\n"),n=r.html(),n=n.replace(/\n{3,}/g,"\n\n"),n=n.replace(/<BR>/gi,"<br>\n"),n=n.replace(/<.+?>/gi,function(e){return e=e.replace(/COLOR:/g,"color:"),e=e.replace(/rgb\(\d+,(?: |&nbsp;)?\d+,(?: |&nbsp;)?\d+\)/gi,function(e){return Utils.colorToHex(e)})}),e.IE&&(n=n.replace(/<(\w+)/gi,function(e,t){return"<"+t.toLowerCase()}),n=n.replace(/(\w+)>/gi,function(e,t){return t.toLowerCase()+">"})),n}var r,i="",o=!1;e.addPlugin({id:"codemirror",title:"源代码",waitTime:0,init:function(){e.loadCss(e.config.cBase.libDir+"codemirror/codemirror.css"),e.load.loadOneFile(e.config.cBase.libDir+"codemirror/codemirror.js",function(){e.load.loadOneFile(e.config.cBase.libDir+"codemirror/xml.js")})},click:function(){var a=this;if("undefined"!=typeof CodeMirror){var s=e.curEditor,l=t("#"+s.Eid+" textarea"),c="";if(o)c=r.getValue(),t(".CodeMirror").remove(),t("#"+s.Eid+" iframe").show(0,function(){s.setContent(c)}),o=!1,this.clicked(!1),i&&e.utils.setSelectionByOffset(e.curEditor.win,i),i="";else{i=e.utils.getSelectionOffset(s.win),this.clicked(!0),c=n(s.getContent()),l.val(c);var d=t("#"+s.Eid+" iframe");d.hide(),r=CodeMirror.fromTextArea(l[0],{mode:"text/html",lineNumbers:!0,lineWrapping:!0,tabMode:"indent",autoCloseTags:!0}),o=!0,d.closest(".bke-iframeholder").height(t(".CodeMirror").height())}s.isShowSource=o,a.waitTime=0}else a.waitTime>1e4&&e.error.writeError("no mirror_lib error: codemirror.js loading timeout",3,"plugin"),setTimeout(function(){a.click()},200),a.waitTime+=200}})})(jQuery.jQEditor,jQuery);