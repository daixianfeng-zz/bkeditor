/*! Bkeditor - v0.9.0 - 2013-07-30
* https://github.com/daixianfeng/bkeditor
* Copyright (c) 2013 daixianfeng;*/
(function(E,$){function onePlupload(){if(!$(".bke-dialog div[name=tab1]").is(":hidden")){uploader1&&uploader1.destroy();var conf=E.curEditor.config.cBase.plupload;uploader1=new plupload.Uploader({runtimes:"flash",browse_button:"pickfile",multi_selection:!1,container:"container1",max_file_size:conf.max_file_size,url:conf.url,flash_swf_url:conf.pluploadswf,filters:[{title:"Image files",extensions:"jpg,gif,png"}],resize:{width:1024,height:768,quality:90}}),uploader1.init(),uploader1.bind("FilesAdded",function(e){e.refresh(),uploader1.start()}),uploader1.bind("UploadProgress",function(e,t){$("#container1 span").html("已上传"+t.percent+"%")}),uploader1.bind("Error",function(e){e.refresh()}),uploader1.bind("FileUploaded",function(up,file,obj){eval("var o = "+obj.response),o.url&&$("#imagedialog").find("input[name=url]").val(o.url),setTimeout(function(){$("#container1 span").html("")},1e3)})}}function multPlupload(){if(!$(".bke-dialog div[name=tab2]").is(":hidden")){uploader2&&uploader2.destroy();var conf=E.curEditor.config.cBase.plupload;uploader2=new plupload.Uploader({runtimes:"flash",browse_button:"pickfiles",container:"container2",max_file_size:conf.max_file_size,url:conf.url,flash_swf_url:conf.pluploadswf,filters:[{title:"Image files",extensions:"jpg,gif,png"}],resize:{width:1024,height:768,quality:90}}),uploader2.init(),uploader2.bind("FilesAdded",function(e,t){$.each(t,function(e,t){$("#filelist").append('<a id="'+t.id+'" class="bke-image-thumb">'+t.name+" ("+plupload.formatSize(t.size)+") <b></b>"+"</a>")}),e.refresh(),uploader2.start()}),uploader2.bind("UploadProgress",function(e,t){$("#"+t.id+" b").html(t.percent+"%")}),uploader2.bind("Error",function(e,t){$("#filelist").append("<div>Error: "+t.code+", Message: "+t.message+(t.file?", File: "+t.file.name:"")+"</div>"),e.refresh()}),uploader2.bind("FileUploaded",function(up,file,obj){eval("var o = "+obj.response),o.url&&$("#"+file.id).html('<img src="'+o.url+'" width="100%"><span title="删除">×</span>')})}}E.addUi({id:"imagedialog",check:function(){if(!$(".bke-dialog div[name=tab1]").is(":visible"))return!0;var e=this.getValues();return e.link?void 0:(this.error("请输入正确的图片地址"),!1)},submit:function(){var e="";if($(".bke-dialog div[name=tab1]").is(":visible")){var t=this.getValues();e='<a href="'+t.link+'" target="'+t.target+'"><img src="'+t.url+'"',t.title&&(e+=' title="'+t.title+'"'),t.align&&(e+=' align="'+t.align+'"'),t.width&&(e+=' width="'+t.width+'"'),t.height&&(e+=' height="'+t.height+'"'),e+="/></a>"}else $(".bke-dialog .bke-image-filelist img").each(function(){e+='<img src="'+$(this).attr("src")+'"/>'});return e},callback:function(){setTimeout(function(){onePlupload(),multPlupload()},0)},beforeunload:function(){uploader1.destroy(),uploader2.destroy()}}),$(document).delegate(".bke-tabs a","click",function(){var e=$(this).attr("name");$(".bke-tabs a").removeClass("bke-tabs-selected").filter("a[name="+e+"]").addClass("bke-tabs-selected"),$("div[name=tab1],div[name=tab2]").hide(),$("div[name="+e+"]").show(),"tab2"===e&&multPlupload()}),$(document).delegate(".bke-dialog :input[name=url]","change",function(){var e=$.trim(this.value);if(e){var t=new Image;t.onload=function(){$(".bke-dialog .bke-image-preview").html('<img src="'+e+'" width="160" />'),$(".bke-dialog .bke-image-size").html("宽："+this.width+"px<br>高："+this.height+"px")},t.onerror=function(){$(".bke-dialog .bke-image-preview").html("图片加载失败！"),$(".bke-dialog .bke-image-size").html("")},t.src=e}});var uploader1,uploader2})(jQuery.jQEditor,jQuery),function(e){e.dialogHtml.imagedialog='<div ui="imagedialog" style="width:580px; height:300px"><div class="bke-tabs"><a class="bke-tabs-first bke-tabs-selected" name="tab1">单张插入</a><a name="tab2">批量上传</a></div><div name="tab1"><table><tr><td width="60">地 址：<span style="color:red">*</span></td><td width="300"><input type="text" name="url" style="width:280px"/></td><td width="180" rowspan="8" align="right" valign="top"><div class="bke-image-preview">图片预览</div><div class="bke-image-size"></div></td></tr><tr><td></td><td id="container1">输入图片地址 或 <a id="pickfile" title="上传成功之后，会自动生成地址">上传一张图片</a> <span></span></td></tr><tr><td>链 接：</td><td><input type="text" name="link" style="width:280px"/></td></tr><tr><td></td><td><select name="target"><option value="_blank" selected="selected">新窗口打开链接</option><option value="_top">当前窗口打开链接</option></select></td></tr><tr><td>描 述：</td><td><input type="text" name="title" style="width:280px"/></td></tr><tr><td>宽 度：</td><td><input type="text" name="width"/> px</td></tr><tr><td>高 度：</td><td><input type="text" name="height"/> px</td><td>&nbsp;</td></tr><tr><td>对 齐：</td><td><select name="align"><option value="left" selected="selected">图片局左</option><option value="center">图片居中</option><option value="right">图片局右</option></select></td></tr></table></div><div name="tab2" style="display:none; "><div id="container2" style="line-height:25px;"><a id="pickfiles">选择图片</a><span></span></div><div id="filelist" class="bke-image-filelist"></div></div></div>'}(jQuery.jQEditor),function(e){function t(){var t=$(e.curEditor.dom).find("."+e.curEditor.config.selectImgClass);return t.length>0?t:$(e.utils.getCurElement().pop()).prev("img")}e.addPlugin({id:"image",type:"dialog",waitTime:0,init:function(){e.load.loadOneFile(e.config.cBase.libDir+"plupload/plupload.js"),e.utils.loadDialog(this.id,e.config.cBase.uiDir+"image/")},showDialog:function(t){var n=this;if("undefined"!=typeof plupload){var i=t.Eid;e.dialog.open({id:"imagedialog",editor:i,title:"图片",content:$("[ui=imagedialog]"),ok:function(){return e.ui("imagedialog").check()?(e.dialog.revertSelection(),e.command("imagedialog"),void 0):!1},cancel:function(){e.dialog.close("imagedialog")},init:function(){e.ui("imagedialog").callback()},beforeunload:function(){e.ui("imagedialog").beforeunload()},icon:"succeed"})}else n.waitTime>1e4&&e.error.writeError("no mirror_lib error: codemirror.js loading timeout",3,"plugin"),setTimeout(function(){n.showDialog(t)},200),n.waitTime+=200},imgFloat:function(e){var n="";switch(e=parseInt(e)){case 1:n="left";break;case 2:n="none";break;case 3:n="right";break;default:n="none"}var i=t();$(i).css("float",n)},preInsert:function(e){return'<a href="'+e.link+'" target="'+e.target+'"><img src="'+e.url+'" style="width:'+e.width+";height:"+e.height+';"/></a>'}})}(jQuery.jQEditor);