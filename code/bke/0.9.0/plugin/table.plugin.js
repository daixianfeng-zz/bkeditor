/*! Bkeditor - v0.9.0 - 2013-07-30
* https://github.com/daixianfeng/bkeditor
* Copyright (c) 2013 daixianfeng;*/
(function(e,t){e.addUi({id:"tabledialog",submit:function(){var n=t("#tabledialog");if(0!==n.size()){var r=n.find("[name=title]")[0].checked,i=n.find("[name=col]").val(),o=n.find("[name=row]").val(),a=n.find("[name=float]:checked").val(),s=n.find("[name=head]")[0].checked,l=e.utils.execPlugin("table","preInsert",{title:r,head:s,col:i,row:o,"float":a});return l}return!1},changeAttr:function(){var n=t("#tableattrdialog");if(0===n.size())return!1;var r=n.find("[name=title]")[0].checked,i=n.find("[name=col]").val(),o=n.find("[name=row]").val(),a=n.find("[name=float]:checked").val(),s=n.find("[name=head]")[0].checked;e.utils.execPlugin("table","changeTableAttr",{title:r,head:s,col:i,row:o,"float":a})},setValues:function(e){var n=t("#tableattrdialog:visible");n.length>0&&(n.find("[name=float][value="+e.float+"]")[0].checked=!0,n.find("[name=title]")[0].checked=e.title?!0:!1,n.find("[name=head]")[0].checked=e.head?!0:!1,e.row&&n.find("[name=row]").val(e.row),n.find("[name=row]")[0].disabled=!0,e.col&&n.find("[name=col]").val(e.col),n.find("[name=col]")[0].disabled=!0)}})})(window.jQuery.jQEditor,window.jQuery),function(e){e.dialogHtml.tabledialog='<TABLE ui="tabledialog"><TR><TD>表格模板</TD><TD><select id="table-template" name="template"><option value="tpl1" selected="selected">模板1</option><option value="tpl2">模板2</option></select></TD><TD> &nbsp </TD></TR><TR><TD>表格标题</TD><TD><input type="checkbox" id="table-title" name="title" /></TD></TR><TR><TD>表头</TD><TD><input type="checkbox" id="table-head" name="head" /></TD><TD> &nbsp </TD></TR><TR><TD>行</TD><TD><input type="text" id="table-col" name="row" value="4"/></TD><TD> &nbsp </TD></TR><TR><TD>列</TD><TD><input type="text" id="table-row" name="col" value="3"/></TD><TD> &nbsp </TD></TR><TR><TD>浮动方式</TD><TD><p><input type="radio" id="table-float-left" name="float" value="1"/>左浮动<input type="radio" id="table-align-center" name="float" checked="checked" value="2"/>居中<input type="radio" id="table-align-right" name="float" value="3"/>右浮动</p></TD><!--<TD><p><input type="radio" id="table-align-lt" name="align" value="1"/>居左上<input type="radio" id="table-align-ct" name="align" value="2"/>居中上<input type="radio" id="table-align-rt" name="align" value="3"/>居右上</p><p><input type="radio" id="table-align-lm" name="align" value="4"/>居左中<input type="radio" id="table-align-cm" name="align" checked="checked" value="5"/>居&nbsp&nbsp中<input type="radio" id="table-align-rm" name="align" value="6"/>居右中</p><p><input type="radio" id="table-align-lb" name="align" value="7"/>居左下<input type="radio" id="table-align-cb" name="align" value="8"/>居中下<input type="radio" id="table-align-rb" name="align" value="9"/>居右下</p></TD>  --><TD> &nbsp </TD></TR></TABLE>'}(jQuery.jQEditor),function(e,t){function n(n){return n?t(e.curEditor.dom).find(n).find("."+e.curEditor.config.selectCellClass):t(e.curEditor.dom).find("."+e.curEditor.config.selectCellClass)}function r(){return t(e.utils.getCurElement().pop()).closest("td,th")}function i(){var n=t(e.curEditor.dom).find("."+e.curEditor.config.selectTableClass);return n.length>0?n:t(e.utils.getCurElement().pop()).closest("table")}function o(e){var i={curTable:e,startCol:-1,endCol:-1,startRow:-1,endRow:-1},o=n(e);if(0!==o.length){var a=t(o[0]),s=t(o[o.length-1]);i.startCol=parseInt(a.attr("col")),i.startRow=parseInt(a.attr("row")),i.endCol=parseInt(s.attr("col")),i.endRow=parseInt(s.attr("row"));var l=s.attr("colspan")?parseInt(s.attr("colspan")):1,d=s.attr("rowspan")?parseInt(s.attr("rowspan")):1;i.endCol+=l-1,i.endRow+=d-1}else{o=t(r()),i.startCol=parseInt(o.attr("col")),i.startRow=parseInt(o.attr("row"));var l=o.attr("colspan")?parseInt(o.attr("colspan")):1,d=o.attr("rowspan")?parseInt(o.attr("rowspan")):1;i.endCol=i.startCol+l-1,i.endRow=i.startRow+d-1}return i.curTable=o.closest("table"),i}e.addPlugin({id:"table",type:"dialog",selectCellClass:"bke-cell-selected",selectTableClass:"bke-table-selected",tableFreshed:"",init:function(){e.utils.loadDialog(this.id,e.config.cBase.uiDir+"table/")},showDialog:function(n){var r=n?n.Eid:e.curEditor.Eid;e.dialog.open({id:"tabledialog",editor:r,title:"插入表格",content:t("[ui=tabledialog]"),ok:function(){e.dialog.revertSelection(),e.command("tabledialog")},cancel:function(){e.dialog.close("tabledialog")},icon:"succeed"})},insert:function(t){var n=t.split("-"),r={row:n[0],col:n[1],floatStyle:"",head:0,title:""},i=this.getTableHtml(r);e.coreCommand.editInsert(i)},getTableHtml:function(t){var n=50>parseInt(t.row)?parseInt(t.row):4,r=20>parseInt(t.col)?parseInt(t.col):3,i="";i=t.floatStyle?" table-"+t.floatStyle:"";var o='<table class="table '+i+'" border="1" cellpadding="0" border-style="solid" style="width:760px"><tbody>';t.title&&(o+="<caption>"+e.utils.spaceText+"</caption>");for(var a=0;n>a;a++){o+="<tr>";for(var s=0;r>s;s++)o+=t.head&&0===a?'<th row="'+a+'" col="'+s+'">'+e.utils.spaceText+"</th>":'<td row="'+a+'" col="'+s+'">'+e.utils.spaceText+"</td>";o+="</tr>"}return o+="</tbody></table>"},preInsert:function(n){var r=e.curEditor.dom.createElement("table"),i=50>parseInt(n.row)?parseInt(n.row):4,o=20>parseInt(n.col)?parseInt(n.col):3,a=4>parseInt(n.float)?parseInt(n.float):2,s=n.title?!0:!1,l=n.head?!0:!1;t(r).attr({border:1,Cellpadding:0,"border-style":"solid"}),t(r).width("100%"),s&&t(r).prepend("<caption>title</caption>");for(var d=0;i>d;d++){t(r).append("<tr></tr>");for(var c=0;o>c;c++){var u=t(r).find("tr:eq("+d+")");l&&0===d?u.append("<th row="+d+" col="+c+">"+e.utils.spaceText+"</th>"):u.append("<td row="+d+" col="+c+">"+e.utils.spaceText+"</td>")}}var f="";switch(a){case 1:f="left";break;case 2:f="none";break;case 3:f="right";break;default:f="none"}return t(r).css("float",f),r.outerHTML},insertRow:function(n){this.freshTableIndex(i());for(var r=o(),a=t(r.curTable).find("tr").first().find("th,td").length,s={},l={},d={},c=r.startRow;r.endRow>=c;c++){var u=e.curEditor.dom.createElement("tr"),f={},m=0;if("forward"===n){s=t(r.curTable).find("tr:eq("+c+")");for(var p=0;a>p;p++)d=s.find("td,th").eq(p),f=this._cloneRowCell(d,n,m),l=f.cloneCell,m=f.hideCells?f.hideCells:m-1,t(u).append(l);s.before(t(u))}else if("backward"===n){s=t(r.curTable).find("tr:eq("+r.endRow+")");for(var p=0;a>p;p++)d=s.find("td,th").eq(p),f=this._cloneRowCell(d,n,m),l=f.cloneCell,m=f.hideCells?f.hideCells:m-1,t(u).append(l);s.after(t(u))}else e.errorMessage("参数错误")}this.freshTableIndex(r.curTable,!0)},insertCol:function(n){this.freshTableIndex(i());for(var r=o(),a=t(r.curTable).find("tr").length,s={},l={},d={},c={},u=0,f=0;a>f;f++){l=t(r.curTable).find("tr:eq("+f+")");for(var m=r.startCol;r.endCol>=m;m++)"forward"===n?(s=l.find("td,th").eq(m),c=this._cloneColCell(s,n,u),d=c.cloneCell,s.before(d)):"backward"===n?(s=l.find("td,th").eq(r.endCol),c=this._cloneColCell(s,n,u),d=c.cloneCell,s.after(d)):e.errorMessage("参数错误");u=c.hideCells?c.hideCells:u-1}this.freshTableIndex(r.curTable,!0)},combineCell:function(){this.freshTableIndex(i());var r=n(),o=r.length;if(o>1){var a=t(r[o-1]).attr("colspan")?parseInt(t(r[o-1]).attr("colspan")):1,s=t(r[o-1]).attr("rowspan")?parseInt(t(r[o-1]).attr("rowspan")):1,l=parseInt(t(r[o-1]).attr("row"))-parseInt(t(r[0]).attr("row")),d=parseInt(t(r[o-1]).attr("col"))-parseInt(t(r[0]).attr("col"));t(r[0]).attr("colspan",d+a),t(r[0]).attr("rowspan",l+s),r.not(r[0]).hide(),r.not(r[0]).attr("rowspan",1).attr("colspan",1),r.not(r[0]).removeClass(e.curEditor.config.selectCellClass)}},combineColAfter:function(n){this.freshTableIndex(i());var o=r();if(o.length>0){var a=t(o[0]).attr("rowspan")?parseInt(t(o[0]).attr("rowspan")):1,s=t(o[0]).attr("colspan")?parseInt(t(o[0]).attr("colspan")):1,l=t(o[0]).nextAll("td,th").eq(s-1).not(":hidden");if(l.length>0){var d=l.attr("rowspan")?parseInt(l.attr("rowspan")):1,c=l.attr("colspan")?parseInt(l.attr("colspan")):1;if(a===d){if(n)return!0;l.attr("colspan","1").attr("rowspan","1").hide(),o.attr("colspan",s+c)}else{if(n)return!1;e.errorMessage("合并失败，单元格行跨度不一致")}}else{if(n)return!1;e.errorMessage("没有单元格可以合并")}}},combineRowAfter:function(n){this.freshTableIndex(i());var o=r();if(o.length>0){var a=t(o[0]).attr("rowspan")?parseInt(t(o[0]).attr("rowspan")):1,s=t(o[0]).attr("colspan")?parseInt(t(o[0]).attr("colspan")):1,l=parseInt(t(o[0]).attr("col")),d=t(o[0]).closest("tr").nextAll("tr:eq("+(a-1)+")").first().find("td[col="+l+"]:visible,th[col="+l+"]:visible");if(d.length>0){var c=d.attr("rowspan")?parseInt(d.attr("rowspan")):1,u=d.attr("colspan")?parseInt(d.attr("colspan")):1;if(u===s){if(n)return!0;d.attr("colspan","1").attr("rowspan","1").hide(),o.attr("rowspan",a+c)}else{if(n)return!1;e.errorMessage("合并失败，单元格列跨度不一致")}}else{if(n)return!1;e.errorMessage("没有单元格可以合并")}}},splitCellWhole:function(n){this.freshTableIndex(i());var o="object"==typeof n?t(n):r();if(o.length>0){var a=t(o[0]).attr("rowspan")?parseInt(t(o[0]).attr("rowspan")):1,s=t(o[0]).attr("colspan")?parseInt(t(o[0]).attr("colspan")):1,l=parseInt(t(o[0]).attr("col")),d=t(o[0]).closest("tr").nextAll("tr:lt("+(a-1)+")").andSelf().find("td:lt("+(l+s)+"):gt("+(l-1)+"),th:lt("+(l+s)+"):gt("+(l-1)+")").not(":visible");d.length>0?(o.attr("colspan","1").attr("rowspan","1").addClass(e.curEditor.config.selectCellClass),d.attr("colspan","1").attr("rowspan","1").addClass(e.curEditor.config.selectCellClass).show()):e.errorMessage("没有单元格供拆分")}},splitToRows:function(n){this.freshTableIndex(i());var o="object"==typeof n?t(n):r();if(o.length>0){var a=t(o[0]).attr("rowspan")?parseInt(t(o[0]).attr("rowspan")):1,s=t(o[0]).attr("colspan")?parseInt(t(o[0]).attr("colspan")):1,l=parseInt(t(o[0]).attr("col")),d=t(o[0]).closest("tr").nextAll("tr:lt("+(a-1)+")").find("td[col="+l+"]:hidden,th[col="+l+"]:hidden");d.length>0?(o.attr("rowspan","1").addClass(e.curEditor.config.selectCellClass),s>1&&d.attr("colspan",s),d.attr("rowspan","1").addClass(e.curEditor.config.selectCellClass).show()):e.errorMessage("没有行单元格供拆分")}},splitToCols:function(n){this.freshTableIndex(i());var o="object"==typeof n?t(n):r();if(o.length>0){var a=t(o[0]).attr("rowspan")?parseInt(t(o[0]).attr("rowspan")):1,s=t(o[0]).attr("colspan")?parseInt(t(o[0]).attr("colspan")):1,l=t(o[0]).nextAll("td:lt("+(s-1)+"),th:lt("+(s-1)+")").not(":visible");l.length>0?(o.attr("colspan","1").addClass(e.curEditor.config.selectCellClass),a>1&&l.attr("rowspan",a),l.attr("colspan","1").addClass(e.curEditor.config.selectCellClass).show()):e.errorMessage("没有列单元格供拆分")}},deleteCol:function(){this.freshTableIndex(i());for(var e=o(),n=t(e.curTable).find("tr").first().find("th,td").length,r={},a={},s=e.endRow;s>=e.startRow;s--){r=t(e.curTable).find("tr:eq("+s+")");for(var l=n-1;l>=0;l--){a=r.find("td,th").eq(l);var d=this._colInfo(a);if(0>d.isInCol&&d.lastRowspan>1)if(0===d.isInCol+d.lastRowspan){var c=r.next("tr").find("[col="+l+"]");c.attr("rowspan",d.lastRowspan-1).show()}else d.lastVisibleCell.attr("rowspan",d.lastRowspan-1);a.remove()}r.remove()}this.freshTableIndex(e.curTable,!0)},deleteRow:function(){this.freshTableIndex(i());for(var e=o(),n=t(e.curTable).find("tr").length,r={},a={},s=n-1;s>=0;s--){a=t(e.curTable).find("tr:eq("+s+")");for(var l=e.endCol;l>=e.startCol;l--){r=a.find("td,th").eq(l);var d=this._rowInfo(r);if(0>d.isInRow&&d.lastColspan>1)if(0===d.isInRow+d.lastColspan){var c=r.next("td,th");c.attr("colspan",d.lastColspan-1).html("del").show()}else d.lastVisibleCell.attr("colspan",d.lastColspan-1);r.remove()}}this.freshTableIndex(e.curTable,!0)},deleteTable:function(){var e=i();t(e).remove()},tableAttrDialog:function(){var n=i(),r={};switch(n.css("float")){case"left":r.float=1;break;case"none":r.float=2;break;case"right":r.float=3;break;default:r.float=2}var o=n.find("th").length;r.head=o?!0:!1;var a=n.find("caption:first-child").length;r.title=a?!0:!1;var s=n.find("tr").length;r.row=s?s:!1;var l=n.find("tr:first").find("th,td").length;r.col=l?l:!1;var d=e.curEditor.Eid;e.dialog.open({id:"tableattrdialog",editor:d,ui:"tabledialog",title:"表格属性",content:t("[ui=tabledialog]"),ok:function(){e.command("tabledialog","changeAttr")},cancel:function(){e.dialog.close("tabledialog")},icon:"succeed"},r)},freshTableIndex:function(n,r){if(this.tableFreshed!==t(n)[0]||r===!0){var i=e.utils.getSelectionRange(e.curEditor.win,"node"),o=n?t(n):t(e.curEditor.dom).find("table");o.each(function(){var e=[],n=0,r=0,i=0;t(this).find("td:hidden,th:hidden").remove();var o=t(this).find("tr");o.each(function(){var o=t(this).find("td,th");e[r]===void 0&&(e[r]=[]),o.each(function(){for(var i=t(this).attr("colspan")?parseInt(t(this).attr("colspan")):1,o=t(this).attr("rowspan")?parseInt(t(this).attr("rowspan")):1,a=n;e[r][a]!==void 0;)a+=1;if(e[r][a]=t(this),i>1||o>1){for(;i>1;){var s=t(this).clone(!0);s.attr("colspan","1").attr("rowspan","1"),s.html(" ").hide(),e[r][a+i-1]=s;for(var l=o;l>1;){var d=t(this).clone(!0);d.attr("colspan","1").attr("rowspan","1"),d.html(" ").hide(),e[r+l-1]===void 0&&(e[r+l-1]=[]),e[r+l-1][a+i-1]=d,l-=1}i-=1,t(this).after(s)}for(;o>1;){var d=t(this).clone(!0);d.attr("colspan","1").attr("rowspan","1"),d.html(" ").hide(),e[r+o-1]===void 0&&(e[r+o-1]=[]),e[r+o-1][a]=d,o-=1}}n+=1}),i=Math.max(i,e[r].length),r+=1,n=0});for(var a=e.length,s=t(this).find("tr").length;a>s;)t(this).append("<tr></tr>"),s+=1;for(var l=0;a>l;l++)for(var d=Math.max(i,e[l].length),c=t(this).find("tr:eq("+l+")"),u=0;d>u;u++)e[l][u]===void 0&&(e[l][u]=t('<td row="'+l+'" col="'+u+'"></td>')),e[l][u].attr("row",l).attr("col",u),c.append(e[l][u])}),e.utils.setSelectionRange(e.curEditor.win,i,"node"),this.tableFreshed=n?t(n)[0]:""}},toggleHead:function(n){var r=i();if((n===void 0||""===n)&&(n=0!==t(r).find("tr:first").find("th").length?!0:!1),n||0!==t(r).find("tr:first").find("th").length)n&&0!==t(r).find("tr:first").find("th").length&&(t(r).find("tr:first").remove(),this.freshTableIndex(r,!0));else{for(var o=t(r).find("tr:first").find("td").length,a=e.curEditor.dom.createElement("tr"),s=[],l=0;o>l;l++)s[l]=e.curEditor.dom.createElement("th"),s[l].innerHTML="&#8203;",t(a).append(s[l]);t(r).find("tr:first").before(a),e.utils.setCursor(e.curEditor.win,s[0],!0),this.freshTableIndex(r,!0)}},toggleTitle:function(n){var r=i();if((n===void 0||""===n)&&(n=0!==t(r).find("caption:first-child").length?!0:!1),n||0!==t(r).find("caption:first-child").length)n&&0!==t(r).find("caption:first-child").length&&t(r).find("caption:first-child").remove();else{var o=e.curEditor,a=o.dom.createElement("caption");a.innerHTML="&#8203;",t(r).prepend(a),e.utils.setCursor(o.win,a,!0)}},changeTableAttr:function(e){var n=i(),r=4>parseInt(e.float)?parseInt(e.float):2,o=e.title?!0:!1,a=e.head?!0:!1;this.toggleTitle(!o),this.toggleHead(!a);var s="";switch(r){case 1:s="left";break;case 2:s="none";break;case 3:s="right";break;default:s="none"}t(n).css("float",s)},cellJustify:function(e){var i="",o="";switch(e=parseInt(e)){case 1:i="left",o="top";break;case 2:i="center",o="top";break;case 3:i="right",o="top";break;case 4:i="left",o="middle";break;case 5:i="center",o="middle";break;case 6:i="right",o="middle";break;case 7:i="left",o="bottom";break;case 8:i="center",o="bottom";break;case 9:i="right",o="bottom";break;default:i="center",o="middle"}var a=n();(0!==t(a).length||(a=r(),0!==t(a).length))&&(t(a).css("text-align",i),t(a).css("vertical-align",o))},cellColor:function(n){var r=t(e.curEditor.dom).find("body table ."+e.curEditor.config.selectCellClass);0===r.length&&(r=t(e.utils.getCurElement().pop()).closest("td,th")),r.css("background-color",n)},tableFloat:function(e){var n="";switch(e=parseInt(e)){case 1:n="left";break;case 2:n="none";break;case 3:n="right";break;default:n="none"}var r=i();t(r).css("float",n)},_cloneRowCell:function(t,n,r){var i={},o=t.clone().html("newcell"),a="forward"===n?!0:!1,s=this._rowInfo(t);if(0>s.isInRow)!a&&s.addRowspan>1?(o.hide(),0===s.isInRow+s.lastColspan&&s.lastVisibleCell.attr("rowspan",s.addRowspan+1)):o.show();else{var l=this._colInfo(t);0>l.isInCol?l.lastRowspan>1?!a&&-1>l.isInCol||a&&l.isInCol+l.lastRowspan>0?(o.hide(),i.hideCells=l.addColspan,l.lastVisibleCell.attr("rowspan",l.lastRowspan+1)):o.show():o.show():r>0?o.hide():o.show()}return o.removeClass(e.curEditor.config.selectCellClass),o.attr("colspan",1).attr("rowspan",1),o.attr("col",-1).attr("row",-1),i.cloneCell=o,i},_cloneColCell:function(t,n,r){var i={},o=t.clone().html("&#8203;"),a="forward"===n?!0:!1,s=this._colInfo(t);if(0>s.isInCol)!a&&s.addColspan>1?(o.hide(),0===s.isInCol+s.lastRowspan&&s.lastVisibleCell.attr("colspan",s.addColspan+1)):o.show();else{var l=this._rowInfo(t);0>l.isInRow?l.lastColspan>1?!a&&-1>l.isInRow||a&&l.isInRow+l.lastColspan>0?(o.hide(),i.hideCells=l.addRowspan,l.lastVisibleCell.attr("colspan",l.lastColspan+1)):o.show():o.show():r>0?o.hide():o.show()}return o.removeClass(e.curEditor.config.selectCellClass),o.attr("colspan",1).attr("rowspan",1),o.attr("col",-1).attr("row",-1),i.cloneCell=o,i},_rowInfo:function(e){var t={};t=0!==e.not(":visible").length?e.prevAll(":visible").first():e;var n=0===t.length?-1:parseInt(t.attr("col")),r=t.attr("colspan")?parseInt(t.attr("colspan")):1,i=t.attr("rowspan")?parseInt(t.attr("rowspan")):1,o=parseInt(e.attr("col"))-n-r;return{isInRow:o,lastColspan:r,addRowspan:i,lastVisibleCell:t}},_colInfo:function(e){var t={};t=0!==e.not(":visible").length?e.closest("table").find("[col="+parseInt(e.attr("col"))+"]:lt("+parseInt(e.attr("row"))+")").not(":hidden").last():e;var n=0===t.length?-1:parseInt(t.attr("row")),r=t.attr("rowspan")?parseInt(t.attr("rowspan")):1,i=t.attr("colspan")?parseInt(t.attr("colspan")):1,o=parseInt(e.attr("row"))-n-r;return{isInCol:o,lastRowspan:r,addColspan:i,lastVisibleCell:t}}})}(window.jQuery.jQEditor,window.jQuery);